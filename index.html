<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Form Pengajuan Surat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white w-full max-w-xl p-6 rounded-2xl shadow">
    <h1 class="text-2xl font-bold text-center mb-6">Form Pengajuan Surat</h1>

    <!-- ===== notifikasi ===== -->
    <div id="notice" class="hidden mb-4 p-3 rounded border"></div>

    <!-- ===== FORM ===== -->
    <form id="formSurat" class="space-y-4">

      <!-- Nama Pengirim -->
      <div>
        <label class="block font-semibold mb-1">Nama Pengirim</label>
        <input type="text" name="Nama Pengirim" class="w-full p-2 border rounded" required />
      </div>

      <!-- Unit (dropdown dinamis) -->
      <div>
        <label class="block font-semibold mb-1">Unit</label>
        <select id="unitSelect" class="w-full p-2 border rounded" required></select>
        <input type="hidden" name="Unit" id="unitName" />
      </div>

      <!-- Jenis Surat (dropdown dinamis) -->
      <div>
        <label class="block font-semibold mb-1">Jenis Surat</label>
        <select id="jenisSelect" class="w-full p-2 border rounded" required></select>
        <input type="hidden" name="Jenis Surat" id="jenisName" />
      </div>

      <!-- Placeholder dinamis -->
      <div id="placeholdersContainer" class="space-y-3"></div>

      <!-- Tombol -->
      <div class="flex items-center gap-3">
        <button type="submit" id="btnKirim"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
          Kirim
        </button>
        <button type="button" id="btnLoading"
                class="hidden bg-gray-400 text-white px-4 py-2 rounded" disabled>
          Loading...
        </button>


        <!-- Spacer otomatis -->
  <a href="data-ajuan"
     class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 ml-auto rounded">
    Data Ajuan
  </a>
      </div>
    </form>
  </div>

<script>
  // ========== KONFIG ==========
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycby8_2x99tJ-DLU8vHCkrOIh9pujPVzl3IffU1I2BV9n4xUOb4MHM-C1UNsbQ7VePNaXAA/exec"; // Ganti dengan URL Web App Anda

  // ========== Elemen ==========
  const form = document.getElementById("formSurat");
  const unitSelect = document.getElementById("unitSelect");
  const jenisSelect = document.getElementById("jenisSelect");
  const unitName = document.getElementById("unitName");
  const jenisName = document.getElementById("jenisName");
  const placeholdersContainer = document.getElementById("placeholdersContainer");
  const btnKirim = document.getElementById("btnKirim");
  const btnLoading = document.getElementById("btnLoading");
  const notice = document.getElementById("notice");

  // ========== UTIL ==========
  function showNotice(text, ok = true) {
    notice.textContent = text;
    notice.classList.remove("hidden");
    notice.classList.toggle("border-green-500", ok);
    notice.classList.toggle("bg-green-50", ok);
    notice.classList.toggle("text-green-700", ok);
    notice.classList.toggle("border-red-500", !ok);
    notice.classList.toggle("bg-red-50", !ok);
    notice.classList.toggle("text-red-700", !ok);
  }
  function clearNotice() { notice.classList.add("hidden"); notice.textContent = ""; }

  function toggleLoading(loading) {
    btnKirim.classList.toggle("hidden", loading);
    btnLoading.classList.toggle("hidden", !loading);
  }

  // ========== DATA LOADER (GET) ==========
  async function loadUnits() {
    const res = await fetch(WEBAPP_URL);
    const data = await res.json();
    unitSelect.innerHTML = '<option value="">-- Pilih Unit --</option>';
    data.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f.id;
      opt.textContent = f.name;
      unitSelect.appendChild(opt);
    });
  }

  async function loadFiles(folderId) {
    const res = await fetch(`${WEBAPP_URL}?folderId=${encodeURIComponent(folderId)}`);
    const data = await res.json();
    jenisSelect.innerHTML = '<option value="">-- Pilih Jenis Surat --</option>';
    data.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f.id;
      opt.textContent = f.name;
      jenisSelect.appendChild(opt);
    });
  }

  async function loadPlaceholders(fileId) {
    const res = await fetch(`${WEBAPP_URL}?fileId=${encodeURIComponent(fileId)}`);
    const data = await res.json();
    placeholdersContainer.innerHTML = "";
    (data.placeholders || []).forEach(ph => {
      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <label class="block font-semibold mb-1">${ph}</label>
        <input type="text" name="${ph}" class="w-full p-2 border rounded" required />
      `;
      placeholdersContainer.appendChild(wrap);
    });
  }

  // ========== EVENTS ==========
  unitSelect.addEventListener("change", async (e) => {
    clearNotice();
    placeholdersContainer.innerHTML = "";
    jenisSelect.innerHTML = "";
    unitName.value = ""; jenisName.value = "";

    const selected = unitSelect.options[unitSelect.selectedIndex];
    if (!selected.value) return;

    unitName.value = selected.textContent;

    toggleLoading(true);
    try {
      await loadFiles(selected.value);
    } catch (err) {
      showNotice("Gagal memuat jenis surat. Cek Web App.", false);
      console.error(err);
    } finally {
      toggleLoading(false);
    }
  });

  jenisSelect.addEventListener("change", async (e) => {
    clearNotice();
    placeholdersContainer.innerHTML = "";
    jenisName.value = "";

    const selected = jenisSelect.options[jenisSelect.selectedIndex];
    if (!selected.value) return;

    jenisName.value = selected.textContent;

    toggleLoading(true);
    try {
      await loadPlaceholders(selected.value);
    } catch (err) {
      showNotice("Gagal memuat placeholder. Cek Web App.", false);
      console.error(err);
    } finally {
      toggleLoading(false);
    }
  });

  // SUBMIT: Menggunakan fetch API (dari jamiewilson)
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearNotice();
    toggleLoading(true);

    const formData = new FormData(form);

    try {
      const response = await fetch(WEBAPP_URL, {
        method: "POST",
        body: formData
      });

      if (!response.ok) {
        throw new Error("Network response was not ok");
      }

      const data = await response.json();

      if (data.result === "success") {
        showNotice(`✅ Pengajuan berhasil dikirim!`, true);
        form.reset();
        placeholdersContainer.innerHTML = "";
        jenisSelect.innerHTML = "";
        unitSelect.selectedIndex = 0;
      } else {
        showNotice("❌ Gagal mengirim: " + (data.error || "Unknown error"), false);
      }
    } catch (err) {
      showNotice("❌ Gagal mengirim: " + err.message, false);
      console.error(err);
    } finally {
      toggleLoading(false);
    }
  });

  // INIT
  (async () => {
    toggleLoading(true);
    try {
      await loadUnits();
    } catch (err) {
      showNotice("Gagal memuat Unit. Cek Web App & akses.", false);
      console.error(err);
    } finally {
      toggleLoading(false);
    }
  })();
</script>
</body>
</html>